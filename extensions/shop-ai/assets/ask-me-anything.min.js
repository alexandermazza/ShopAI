const AskMeAnything={async waitForJudgeMeReviews(e=2e4){let t=document.querySelectorAll(".jdgm-rev");return t.length>0?t:new Promise((t=>{let r=!1;const n=new MutationObserver((()=>{const e=document.querySelectorAll(".jdgm-rev");e.length>0&&(r=!0,n.disconnect(),t(e))}));n.observe(document.body,{childList:!0,subtree:!0}),setTimeout((()=>{if(!r){n.disconnect();const e=document.querySelectorAll(".jdgm-rev");t(e)}}),e)}))},async scrapeReviewContent(){let e="\nCustomer Reviews:\n",t=[];const r=await this.waitForJudgeMeReviews();if(r.length>0)r.forEach(((e,r)=>{if(r>=5)return;const n=e.querySelector(".jdgm-rev__rating"),o=e.querySelector(".jdgm-rev__author");let s="";const i=e.querySelector(".jdgm-rev__body p"),a=e.querySelector(".jdgm-rev__body");s=i&&i.textContent.trim()?i.textContent.trim():a&&a.textContent.trim()?a.textContent.trim():"Review Text Missing";const c=n&&(n.getAttribute("data-score")||n.textContent.trim())||"?",d=o?o.textContent.trim().replace(/\s+/g," "):"";t.push({rating:c,author:d,body:s})}));else{let e=document.querySelectorAll(".spr-review");0===e.length&&(e=document.querySelectorAll(".shopify-product-reviews .review")),e.length>0&&e.forEach(((e,r)=>{if(r>=5)return;const n=e.querySelector(".spr-review-rating, .review-rating"),o=e.querySelector(".spr-review-author, .review-author"),s=e.querySelector(".spr-review-content, .review-content"),i=n?n.textContent.trim().replace(/\s+/g," "):"?",a=o?o.textContent.trim().replace(/\s+/g," "):"",c=s?s.textContent.trim().replace(/\s+/g," "):"Review Text Missing";t.push({rating:i,author:a,body:c})}))}return 0===t.length?"\nCustomer Reviews: No reviews found on this page.\n":(t.forEach(((t,r)=>{e+=`- Review ${r+1}: Rating: ${t.rating}/5. ${t.author?"By: "+t.author+". ":""}Comment: "${t.body}"\n`})),e)},async fetchJudgeMeReviews(e,t){if(!e||!t)return"\nCustomer Reviews: Could not fetch reviews (missing product info).\n";const r=window.location.hostname;let n=[],o=1,s="\nCustomer Reviews:\n";try{for(;;){const e=`https://judge.me/api/v1/reviews?api_token=${window.Shopify?.shop}&shop_domain=${r}&handle=${t.split("/").pop()}&per_page=5&page=${o}`,i=await fetch(e);if(!i.ok){let e=`API Error (${i.status})`;try{e=(await i.json()).message||e}catch(e){}s+=` - Error fetching reviews: ${e}\n`;break}const a=await i.json();if(!a.reviews||0===a.reviews.length)break;a.reviews.forEach((e=>{const t=e.rating||"?",r=e.title||"",o=e.body||"No comment",s=e.reviewer?.name||"Anonymous";n.push({rating:t,author:s,title:r,body:o})})),o++,await new Promise((e=>setTimeout(e,300)))}}catch(e){return s+=" - Error fetching reviews. Please try again later.\n",s}return 0===n.length?"\nCustomer Reviews: No reviews found.\n":(n.forEach(((e,t)=>{s+=`- Review ${t+1}: Rating: ${e.rating}/5. ${e.author?"By: "+e.author+". ":""}${e.title?'Title: "'+e.title+'". ':""}Comment: "${e.body}"\n`})),s)},onMount(e=document){if(!e||"ask-me-anything"!==e.id)return;const t=e.querySelector(".search-input"),r=e.querySelector(".response-area"),n=r?.querySelector(".ai-answer-content"),o=r?.querySelector("#powered-by-attribution"),s=e.dataset.productContext,i=e.dataset.productId,a=e.dataset.productUrl;if(!(t&&r&&n&&o&&s&&i&&a))return t||console.error(">>> searchInput missing"),r||console.error(">>> responseArea missing"),n||console.error(">>> answerContentElement missing"),o||console.error(">>> attributionElement missing"),s||console.error(">>> productContext missing"),i||console.error(">>> productId missing"),a||console.error(">>> productUrl missing"),void(r&&(r.textContent="Error: Could not initialize component.",r.style.display="block",r.className="response-area error"));e.querySelector("form.ask-me-anything-form").addEventListener("submit",(async i=>{i.preventDefault();const a=t.value.trim();if(!a)return;const c=await this.scrapeReviewContent(),d=`${s}\n${c}`;n.textContent="",r.classList.remove("error"),r.classList.add("loading"),r.classList.add("visible"),o.classList.add("hidden"),t.disabled=!0;const l=e.getAttribute("data-language")||"en";try{const e=await fetch("/apps/proxy/resource-openai",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:a,productContext:d,language:l,shop:window.Shopify?.shop||""})});if(!e.ok){let t=`API Error: ${e.status} ${e.statusText}`;try{const r=await e.text();try{const e=JSON.parse(r);t=e.error||e.message||t}catch(e){t=r||t}}catch(i){}return n.textContent=`Error: ${t}`,r.classList.remove("loading"),r.classList.add("error"),r.classList.add("visible"),void o.classList.add("hidden")}const t=(await e.json()).answer||"Sorry, I could not find an answer.";r.classList.remove("loading"),r.classList.remove("error"),r.classList.add("visible"),window.TextGenerateEffect?TextGenerateEffect.animateText(n,t,{duration:.6,staggerDelay:.08,filter:!0}):n.textContent=t,o.classList.remove("hidden")}catch(e){n.textContent=`Error: ${e.message||"An unexpected error occurred."}`,r.classList.remove("loading"),r.classList.add("error","visible"),o.classList.remove("hidden")}finally{t.disabled=!1,t.focus()}}));const c=e.querySelector(".clear-button");c&&t&&(t.addEventListener("input",(()=>{c.classList.toggle("hidden",!t.value)})),c.addEventListener("click",(()=>{t.value="",c.classList.add("hidden"),t.focus()})))}};window.AskMeAnything=AskMeAnything,document.addEventListener("shopify:section:load",(function(e){const t=e.detail.sectionId,r=document.getElementById(`shopify-section-${t}`);if(!r)return;const n=r.querySelector("#ask-me-anything");n&&"true"!==n.dataset.initialized&&(AskMeAnything.onMount(n),n.dataset.initialized="true")})),document.addEventListener("DOMContentLoaded",(()=>{document.querySelectorAll('#ask-me-anything:not([data-initialized="true"])').forEach((e=>{AskMeAnything.onMount(e),e.dataset.initialized="true"}))}));