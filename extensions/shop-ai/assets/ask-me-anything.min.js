const AskMeAnything={cachedReviews:null,reviewsPromise:null,async waitForJudgeMeReviews(e=2e3){let t=document.querySelectorAll(".jdgm-rev");return t.length>0?t:new Promise(t=>{let o=!1;const n=new MutationObserver(()=>{const e=document.querySelectorAll(".jdgm-rev");e.length>0&&(o=!0,n.disconnect(),t(e))});n.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{if(!o){n.disconnect();const e=document.querySelectorAll(".jdgm-rev");t(e)}},e)})},async scrapeReviewContent(){return null!==this.cachedReviews?(console.log("âš¡ Using cached reviews (instant!)"),this.cachedReviews):this.reviewsPromise?(console.log("â³ Waiting for reviews promise to resolve..."),await this.reviewsPromise):(console.log("ðŸ”„ Fetching reviews on-demand..."),await this._fetchReviews())},async _fetchReviews(){let e="\nCustomer Reviews:\n",t=[];const o=await this.waitForJudgeMeReviews();if(o.length>0)o.forEach((e,o)=>{if(o>=5)return;const n=e.querySelector(".jdgm-rev__rating"),s=e.querySelector(".jdgm-rev__author");let r="";const i=e.querySelector(".jdgm-rev__body p"),a=e.querySelector(".jdgm-rev__body");r=i&&i.textContent.trim()?i.textContent.trim():a&&a.textContent.trim()?a.textContent.trim():"Review Text Missing";const c=n&&(n.getAttribute("data-score")||n.textContent.trim())||"?",l=s?s.textContent.trim().replace(/\s+/g," "):"";t.push({rating:c,author:l,body:r})});else{let e=document.querySelectorAll(".spr-review");0===e.length&&(e=document.querySelectorAll(".shopify-product-reviews .review")),e.length>0&&e.forEach((e,o)=>{if(o>=5)return;const n=e.querySelector(".spr-review-rating, .review-rating"),s=e.querySelector(".spr-review-author, .review-author"),r=e.querySelector(".spr-review-content, .review-content"),i=n?n.textContent.trim().replace(/\s+/g," "):"?",a=s?s.textContent.trim().replace(/\s+/g," "):"",c=r?r.textContent.trim().replace(/\s+/g," "):"Review Text Missing";t.push({rating:i,author:a,body:c})})}return 0===t.length?e="\nCustomer Reviews: No reviews found on this page.\n":t.forEach((t,o)=>{e+=`- Review ${o+1}: Rating: ${t.rating}/5. ${t.author?"By: "+t.author+". ":""}Comment: "${t.body}"\n`}),this.cachedReviews=e,console.log("âœ… Reviews cached for instant future access"),e},preloadReviews(){null===this.cachedReviews&&null===this.reviewsPromise&&(console.log("ðŸš€ Preloading reviews in background..."),this.reviewsPromise=this._fetchReviews().then(e=>(this.reviewsPromise=null,e)))},async fetchJudgeMeReviews(e,t){if(!e||!t)return"\nCustomer Reviews: Could not fetch reviews (missing product info).\n";const o=window.location.hostname;let n=[],s=1,r="\nCustomer Reviews:\n";try{for(;;){const e=`https://judge.me/api/v1/reviews?api_token=${window.Shopify?.shop}&shop_domain=${o}&handle=${t.split("/").pop()}&per_page=5&page=${s}`,i=await fetch(e);if(!i.ok){let e=`API Error (${i.status})`;try{e=(await i.json()).message||e}catch(e){}r+=` - Error fetching reviews: ${e}\n`;break}const a=await i.json();if(!a.reviews||0===a.reviews.length)break;a.reviews.forEach(e=>{const t=e.rating||"?",o=e.title||"",s=e.body||"No comment",r=e.reviewer?.name||"Anonymous";n.push({rating:t,author:r,title:o,body:s})}),s++,await new Promise(e=>setTimeout(e,300))}}catch(e){return r+=" - Error fetching reviews. Please try again later.\n",r}return 0===n.length?"\nCustomer Reviews: No reviews found.\n":(n.forEach((e,t)=>{r+=`- Review ${t+1}: Rating: ${e.rating}/5. ${e.author?"By: "+e.author+". ":""}${e.title?'Title: "'+e.title+'". ':""}Comment: "${e.body}"\n`}),r)},onMount(e=document){if(!e||"ask-me-anything"!==e.id)return;const t=e.querySelector(".search-input"),o=e.querySelector(".response-area"),n=o?.querySelector(".ai-answer-content"),s=o?.querySelector("#powered-by-attribution"),r=e.dataset.productContext,i=e.dataset.productId,a=e.dataset.productUrl,c=e.dataset.productImages||"",l=c?c.split(",").filter(e=>e.trim()):[];if(console.log("ðŸ” === ASK ME ANYTHING IMAGE DEBUG ==="),console.log("ðŸ“„ Raw productImages data:",c),console.log("ðŸ“¸ Product images found:",l.length),l.length>0?(console.log("ðŸ–¼ï¸  Image URLs:",l),l.forEach((e,t)=>{console.log(`ðŸ–¼ï¸  Image ${t+1} URL:`,e),console.log(`ðŸ–¼ï¸  Image ${t+1} URL length:`,e.length)})):console.log("âŒ No product images detected - will use text-only mode"),console.log("ðŸ” === END IMAGE DEBUG ==="),!(t&&o&&n&&s&&r&&i&&a))return t||console.error(">>> searchInput missing"),o||console.error(">>> responseArea missing"),n||console.error(">>> answerContentElement missing"),s||console.error(">>> attributionElement missing"),r||console.error(">>> productContext missing"),i||console.error(">>> productId missing"),a||console.error(">>> productUrl missing"),void(o&&(o.textContent="Error: Could not initialize component.",o.style.display="block",o.className="response-area error"));this.preloadReviews();e.querySelector("form.ask-me-anything-form").addEventListener("submit",async i=>{i.preventDefault();const a=t.value.trim();if(!a)return;const c=await this.scrapeReviewContent(),d=`${r}\n${c}`;n.textContent="Thinking...",o.classList.remove("error"),o.classList.add("loading"),o.classList.add("visible"),s.classList.add("hidden"),t.disabled=!0;const u=e.getAttribute("data-language")||"en";try{const e={question:a,productContext:d,language:u,shop:window.Shopify?.shop||""};l.length>0?(e.productImages=l,console.log("ðŸ“¤ ===== SENDING IMAGES TO AI ====="),console.log("ðŸ“¤ Sending",l.length,"images for analysis"),console.log("ðŸ“¤ Image URLs being sent:",l),console.log("ðŸ“¤ ===== END IMAGE SEND =====")):console.log("ðŸ“¤ No images to send - using text-only analysis");const t=await fetch("/apps/proxy/resource-openai",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let e=`API Error: ${t.status} ${t.statusText}`;try{const o=await t.text();try{const t=JSON.parse(o);e=t.error||t.message||e}catch(t){e=o||e}}catch(i){}return n.textContent=`Error: ${e}`,o.classList.remove("loading"),o.classList.add("error"),o.classList.add("visible"),void s.classList.add("hidden")}const r=(await t.json()).answer||"Sorry, I could not find an answer.";o.classList.remove("loading"),o.classList.remove("error"),o.classList.add("visible"),window.TextGenerateEffect?TextGenerateEffect.animateText(n,r,{duration:.6,staggerDelay:.08,filter:!0}):n.textContent=r,s.classList.remove("hidden")}catch(e){n.textContent=`Error: ${e.message||"An unexpected error occurred."}`,o.classList.remove("loading"),o.classList.add("error","visible"),s.classList.remove("hidden")}finally{t.disabled=!1,t.focus()}});const d=e.querySelector(".clear-button");d&&t&&(t.addEventListener("input",()=>{d.classList.toggle("hidden",!t.value)}),d.addEventListener("click",()=>{t.value="",d.classList.add("hidden"),t.focus()}))}};window.AskMeAnything=AskMeAnything,document.addEventListener("shopify:section:load",function(e){const t=e.detail.sectionId,o=document.getElementById(`shopify-section-${t}`);if(!o)return;const n=o.querySelector("#ask-me-anything");n&&"true"!==n.dataset.initialized&&(AskMeAnything.onMount(n),n.dataset.initialized="true")}),document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll('#ask-me-anything:not([data-initialized="true"])').forEach(e=>{AskMeAnything.onMount(e),e.dataset.initialized="true"})});